#!/bin/bash
#
# File: .git/hooks/pre-commit
# Description: Pre-commit hook to ensure FixRecord.md is updated when bug fixes are committed
# Author: Libor Ballaty <libor@arionetworks.com>
# Created: 2025-11-16
#

# ANSI color codes
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}üîç Pre-commit hook: Checking for FixRecord.md updates...${NC}"

# Detect if --no-verify was suggested to be used inappropriately
# This won't stop --no-verify but logs when hook runs normally
if [ -f ".git/NO_VERIFY_USED" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  Warning: --no-verify was recently used. Use sparingly!${NC}"
fi

# Get the list of staged files
STAGED_FILES=$(git diff --cached --name-only)

# Keywords that indicate a fix (case insensitive)
FIX_KEYWORDS="fix|bug|error|issue|patch|correct|resolve"

# Check if commit message contains fix keywords
# Note: We check the commit message file if it exists, or prompt for it
COMMIT_MSG_FILE=".git/COMMIT_EDITMSG"
COMMIT_MSG=""

if [ -f "$COMMIT_MSG_FILE" ]; then
    COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")
fi

# Function to check if this is a fix-related commit
is_fix_commit() {
    # Check staged files for common fix patterns
    echo "$STAGED_FILES" | grep -qiE '\.(js|ts|html|css|sql|py|java|go|rb|php|md)$' && \
    (
        # Check if any of the staged files are in src/, database/, or contain common fix file patterns
        echo "$STAGED_FILES" | grep -qE '(src/|database/|\.fix\.|\.patch\.)' || \
        # Or if there are JavaScript/code files being modified
        echo "$STAGED_FILES" | grep -qE '\.(js|ts|sql|py|java|go)$'
    )
}

# Check if FixRecord.md is in the staged files
FIXRECORD_STAGED=$(echo "$STAGED_FILES" | grep -x "FixRecord.md")

# Determine if this looks like a fix commit
IS_FIX=false

if is_fix_commit; then
    IS_FIX=true
fi

# If commit message contains fix keywords, it's definitely a fix
if echo "$COMMIT_MSG" | grep -qiE "$FIX_KEYWORDS"; then
    IS_FIX=true
fi

# If this is a fix commit and FixRecord.md is NOT staged, warn the user
if [ "$IS_FIX" = true ] && [ -z "$FIXRECORD_STAGED" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  Warning: This appears to be a bug fix or code correction.${NC}"
    echo -e "${YELLOW}   FixRecord.md has not been updated.${NC}"
    echo ""
    echo -e "${BLUE}   Staged files:${NC}"
    echo "$STAGED_FILES" | sed 's/^/   - /'
    echo ""
    echo -e "${YELLOW}   Please update FixRecord.md to document this fix:${NC}"
    echo -e "   1. Open FixRecord.md"
    echo -e "   2. Add a new entry describing the fix"
    echo -e "   3. Stage the file: ${GREEN}git add FixRecord.md${NC}"
    echo -e "   4. Retry the commit"
    echo ""
    echo -e "${YELLOW}   Or bypass this check (NOT recommended): ${RED}git commit --no-verify${NC}"
    echo ""

    # Ask user if they want to continue anyway
    read -p "$(echo -e ${YELLOW}Do you want to continue without updating FixRecord.md? [y/N]: ${NC})" -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo -e "${RED}‚ùå Commit aborted. Please update FixRecord.md and try again.${NC}"
        exit 1
    else
        echo -e "${YELLOW}‚ö†Ô∏è  Proceeding without FixRecord.md update (not recommended)${NC}"
    fi
else
    if [ -n "$FIXRECORD_STAGED" ]; then
        echo -e "${GREEN}‚úÖ FixRecord.md is being updated in this commit${NC}"
    else
        echo -e "${BLUE}‚ÑπÔ∏è  No fix-related changes detected, skipping FixRecord.md check${NC}"
    fi
fi

echo -e "${GREEN}‚úÖ Pre-commit checks passed${NC}"
exit 0
