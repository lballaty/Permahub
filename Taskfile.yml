# Taskfile for Permahub CI/CD
# File: /Users/liborballaty/LocalProjects/GitHubProjectsDocuments/Permahub/Taskfile.yml
# Description: Local CI/CD task orchestration for Permahub project
# Author: Libor Ballaty <libor@arionetworks.com>
# Created: 2025-11-17

version: '3'

vars:
  PROJECT_NAME: Permahub
  BUILD_DIR: dist
  NODE_VERSION: 18

tasks:
  # ============================================================================
  # Development Tasks
  # ============================================================================

  dev:
    desc: Start development server
    cmds:
      - npm run dev

  # ============================================================================
  # Quality Control Tasks
  # ============================================================================

  lint:
    desc: Run ESLint on source code
    cmds:
      - echo "ğŸ” Linting code..."
      - npm run lint

  lint:fix:
    desc: Run ESLint and auto-fix issues
    cmds:
      - echo "ğŸ”§ Linting and fixing code..."
      - npm run lint:fix

  format:
    desc: Format code with Prettier
    cmds:
      - echo "ğŸ’… Formatting code..."
      - npm run format

  format:check:
    desc: Check code formatting without fixing
    cmds:
      - echo "ğŸ” Checking code format..."
      - npm run format:check

  # ============================================================================
  # Testing Tasks
  # ============================================================================

  test:smoke:
    desc: Run smoke tests (quick sanity check)
    cmds:
      - echo "ğŸ’¨ Running smoke tests..."
      - npm run test:smoke

  test:critical:
    desc: Run critical path tests
    cmds:
      - echo "âš ï¸  Running critical tests..."
      - npm run test:critical

  test:unit:
    desc: Run unit tests
    cmds:
      - echo "ğŸ§ª Running unit tests..."
      - npm run test:unit

  test:integration:
    desc: Run integration tests
    cmds:
      - echo "ğŸ”— Running integration tests..."
      - npm run test:integration

  test:e2e:
    desc: Run end-to-end tests
    cmds:
      - echo "ğŸ­ Running E2E tests..."
      - npm run test:e2e

  test:ci:
    desc: Run CI test suite (smoke + critical + integration)
    cmds:
      - echo "ğŸ¤– Running CI test suite..."
      - npm run test:ci

  test:all:
    desc: Run all tests
    cmds:
      - echo "ğŸ¯ Running all tests..."
      - npm run test:all

  # ============================================================================
  # Build Tasks
  # ============================================================================

  clean:
    desc: Clean build artifacts
    cmds:
      - echo "ğŸ§¹ Cleaning build directory..."
      - rm -rf {{.BUILD_DIR}}
      - echo "âœ… Clean complete"

  build:
    desc: Build production bundle
    deps: [clean]
    cmds:
      - echo "ğŸ—ï¸  Building production bundle..."
      - npm run build
      - echo "âœ… Build complete - artifacts in {{.BUILD_DIR}}/"

  build:preview:
    desc: Build and preview production bundle locally
    deps: [build]
    cmds:
      - echo "ğŸ‘€ Starting preview server..."
      - npm run preview

  # ============================================================================
  # Pre-deployment Validation
  # ============================================================================

  pre-deploy:
    desc: Run all pre-deployment checks
    deps: [lint, test:ci]
    cmds:
      - echo "âœ… All pre-deployment checks passed"

  # ============================================================================
  # Deployment Tasks
  # ============================================================================

  deploy:gh-pages:
    desc: Deploy to GitHub Pages
    deps: [pre-deploy, build]
    cmds:
      - echo "ğŸš€ Deploying to GitHub Pages..."
      - npm run deploy:gh-pages
      - echo "âœ… Deployment complete!"
      - echo "ğŸŒ Site will be available at https://username.github.io/Permahub/"

  deploy:
    desc: Full deployment workflow (validate â†’ build â†’ deploy)
    cmds:
      - task: deploy:gh-pages

  # ============================================================================
  # Database Tasks
  # ============================================================================

  db:verify:
    desc: Verify database seed files
    cmds:
      - echo "ğŸ—„ï¸  Verifying database seed files..."
      - npm run verify:seed:all

  # ============================================================================
  # Combined Workflows
  # ============================================================================

  check:
    desc: Run all code quality checks (lint + format + test)
    cmds:
      - task: lint
      - task: format:check
      - task: test:ci

  fix:
    desc: Auto-fix code issues (lint + format)
    cmds:
      - task: lint:fix
      - task: format

  # ============================================================================
  # Git Hook Helpers (called by simple-git-hooks)
  # ============================================================================

  pre-commit:
    desc: Pre-commit hook tasks
    cmds:
      - task: lint
      - task: test:smoke

  pre-push:
    desc: Pre-push hook tasks
    cmds:
      - task: test:ci

  # ============================================================================
  # Information Tasks
  # ============================================================================

  info:
    desc: Show project information
    cmds:
      - echo "ğŸ“¦ Project {{.PROJECT_NAME}}"
      - echo "ğŸ“ Build Directory {{.BUILD_DIR}}"
      - echo "ğŸŸ¢ Node Version {{.NODE_VERSION}}+"
      - echo ""
      - echo "Available tasks run 'task --list'"

  default:
    desc: Show available tasks
    cmds:
      - task --list
